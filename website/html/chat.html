<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISEPChat - Conversa</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <!-- -->
    <style>
        /***********************************************************************/
        /**************************   normalize.css   **************************/
        /***********************************************************************/
    
        /*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */
    
        /* Document
        ========================================================================== */
    
        /**
        * 1. Correct the line height in all browsers.
        * 2. Prevent adjustments of font size after orientation changes in iOS.
        */
    
        html {
        line-height: 1.15; /* 1 */
        -webkit-text-size-adjust: 100%; /* 2 */
        }
    
        /* Sections
        ========================================================================== */
    
        /**
        * Remove the margin in all browsers.
        */
    
        body {
        margin: 0;
        }
    
        /**
        * Render the `main` element consistently in IE.
        */
    
        main {
        display: block;
        }
    
        /**
        * Correct the font size and margin on `h1` elements within `section` and
        * `article` contexts in Chrome, Firefox, and Safari.
        */
    
        h1 {
        font-size: 2em;
        margin: 0.67em 0;
        }
    
        /* Grouping content
        ========================================================================== */
    
        /**
        * 1. Add the correct box sizing in Firefox.
        * 2. Show the overflow in Edge and IE.
        */
    
        hr {
        box-sizing: content-box; /* 1 */
        height: 0; /* 1 */
        overflow: visible; /* 2 */
        }
    
        /**
        * 1. Correct the inheritance and scaling of font size in all browsers.
        * 2. Correct the odd `em` font sizing in all browsers.
        */
    
        pre {
        font-family: monospace, monospace; /* 1 */
        font-size: 1em; /* 2 */
        }
    
        /* Text-level semantics
        ========================================================================== */
    
        /**
        * Remove the gray background on active links in IE 10.
        */
    
        a {
        background-color: transparent;
        }
    
        /**
        * 1. Remove the bottom border in Chrome 57-
        * 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.
        */
    
        abbr[title] {
        border-bottom: none; /* 1 */
        text-decoration: underline; /* 2 */
        text-decoration: underline dotted; /* 2 */
        }
    
        /**
        * Add the correct font weight in Chrome, Edge, and Safari.
        */
    
        b,
        strong {
        font-weight: bolder;
        }
    
        /**
        * 1. Correct the inheritance and scaling of font size in all browsers.
        * 2. Correct the odd `em` font sizing in all browsers.
        */
    
        code,
        kbd,
        samp {
        font-family: monospace, monospace; /* 1 */
        font-size: 1em; /* 2 */
        }
    
        /**
        * Add the correct font size in all browsers.
        */
    
        small {
        font-size: 80%;
        }
    
        /**
        * Prevent `sub` and `sup` elements from affecting the line height in
        * all browsers.
        */
    
        sub,
        sup {
        font-size: 75%;
        line-height: 0;
        position: relative;
        vertical-align: baseline;
        }
    
        sub {
        bottom: -0.25em;
        }
    
        sup {
        top: -0.5em;
        }
    
        /* Embedded content
        ========================================================================== */
    
        /**
        * Remove the border on images inside links in IE 10.
        */
    
        img {
        border-style: none;
        }
    
        /* Forms
        ========================================================================== */
    
        /**
        * 1. Change the font styles in all browsers.
        * 2. Remove the margin in Firefox and Safari.
        */
    
        button,
        input,
        optgroup,
        select,
        textarea {
        font-family: inherit; /* 1 */
        font-size: 100%; /* 1 */
        line-height: 1.15; /* 1 */
        margin: 0; /* 2 */
        }
    
        /**
        * Show the overflow in IE.
        * 1. Show the overflow in Edge.
        */
    
        button,
        input { /* 1 */
        overflow: visible;
        }
    
        /**
        * Remove the inheritance of text transform in Edge, Firefox, and IE.
        * 1. Remove the inheritance of text transform in Firefox.
        */
    
        button,
        select { /* 1 */
        text-transform: none;
        }
    
        /**
        * Correct the inability to style clickable types in iOS and Safari.
        */
    
        button,
        [type="button"],
        [type="reset"],
        [type="submit"] {
        -webkit-appearance: button;
        }
    
        /**
        * Remove the inner border and padding in Firefox.
        */
    
        button::-moz-focus-inner,
        [type="button"]::-moz-focus-inner,
        [type="reset"]::-moz-focus-inner,
        [type="submit"]::-moz-focus-inner {
        border-style: none;
        padding: 0;
        }
    
        /**
        * Restore the focus styles unset by the previous rule.
        */
    
        button:-moz-focusring,
        [type="button"]:-moz-focusring,
        [type="reset"]:-moz-focusring,
        [type="submit"]:-moz-focusring {
        outline: 1px dotted ButtonText;
        }
    
        /**
        * Correct the padding in Firefox.
        */
    
        fieldset {
        padding: 0.35em 0.75em 0.625em;
        }
    
        /**
        * 1. Correct the text wrapping in Edge and IE.
        * 2. Correct the color inheritance from `fieldset` elements in IE.
        * 3. Remove the padding so developers are not caught out when they zero out
        *    `fieldset` elements in all browsers.
        */
    
        legend {
        box-sizing: border-box; /* 1 */
        color: inherit; /* 2 */
        display: table; /* 1 */
        max-width: 100%; /* 1 */
        padding: 0; /* 3 */
        white-space: normal; /* 1 */
        }
    
        /**
        * Add the correct vertical alignment in Chrome, Firefox, and Opera.
        */
    
        progress {
        vertical-align: baseline;
        }
    
        /**
        * Remove the default vertical scrollbar in IE 10+.
        */
    
        textarea {
        overflow: auto;
        }
    
        /**
        * 1. Add the correct box sizing in IE 10.
        * 2. Remove the padding in IE 10.
        */
    
        [type="checkbox"],
        [type="radio"] {
        box-sizing: border-box; /* 1 */
        padding: 0; /* 2 */
        }
    
        /**
        * Correct the cursor style of increment and decrement buttons in Chrome.
        */
    
        [type="number"]::-webkit-inner-spin-button,
        [type="number"]::-webkit-outer-spin-button {
        height: auto;
        }
    
        /**
        * 1. Correct the odd appearance in Chrome and Safari.
        * 2. Correct the outline style in Safari.
        */
    
        [type="search"] {
        -webkit-appearance: textfield; /* 1 */
        outline-offset: -2px; /* 2 */
        }
    
        /**
        * Remove the inner padding in Chrome and Safari on macOS.
        */
    
        [type="search"]::-webkit-search-decoration {
        -webkit-appearance: none;
        }
    
        /**
        * 1. Correct the inability to style clickable types in iOS and Safari.
        * 2. Change font properties to `inherit` in Safari.
        */
    
        ::-webkit-file-upload-button {
        -webkit-appearance: button; /* 1 */
        font: inherit; /* 2 */
        }
    
        /* Interactive
        ========================================================================== */
    
        /*
        * Add the correct display in Edge, IE 10+, and Firefox.
        */
    
        details {
        display: block;
        }
    
        /*
        * Add the correct display in all browsers.
        */
    
        summary {
        display: list-item;
        }
    
        /* Misc
        ========================================================================== */
    
        /**
        * Add the correct display in IE 10+.
        */
    
        template {
        display: none;
        }
    
        /**
        * Add the correct display in IE 10.
        */
    
        [hidden] {
        display: none;
        }
    
        /******************************************************************/
        /**************************   font.css   **************************/
        /******************************************************************/
    
        .roboto-thin {
            font-family: "Roboto", sans-serif;
            font-weight: 100;
            font-style: normal;
        }
    
        .roboto-light {
            font-family: "Roboto", sans-serif;
            font-weight: 300;
            font-style: normal;
        }
    
        .roboto-regular {
            font-family: "Roboto", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
    
        .roboto-medium {
            font-family: "Roboto", sans-serif;
            font-weight: 500;
            font-style: normal;
        }
    
        .roboto-bold {
            font-family: "Roboto", sans-serif;
            font-weight: 700;
            font-style: normal;
        }
    
        .roboto-black {
            font-family: "Roboto", sans-serif;
            font-weight: 900;
            font-style: normal;
        }
    
        .roboto-thin-italic {
            font-family: "Roboto", sans-serif;
            font-weight: 100;
            font-style: italic;
        }
    
        .roboto-light-italic {
            font-family: "Roboto", sans-serif;
            font-weight: 300;
            font-style: italic;
        }
    
        .roboto-regular-italic {
            font-family: "Roboto", sans-serif;
            font-weight: 400;
            font-style: italic;
        }
    
        .roboto-medium-italic {
            font-family: "Roboto", sans-serif;
            font-weight: 500;
            font-style: italic;
        }
    
        .roboto-bold-italic {
            font-family: "Roboto", sans-serif;
            font-weight: 700;
            font-style: italic;
        }
    
        .roboto-black-italic {
            font-family: "Roboto", sans-serif;
            font-weight: 900;
            font-style: italic;
        }
    
        /*******************************************************************/
        /**************************   style.css   **************************/
        /*******************************************************************/
    
        * {
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
    
        body {
            margin: 0;
            padding: 0;
            background-color: var(--gray_1);
        }
    
        /* VARIABLES */
        :root {
            /* COLOR */
            --black:black;
            --semi_transparent_black: #00000080;
            --white: white;
            --transparent: #ffffff00;
            --gray_0: #f8f9fa;
            --gray_1: #f1f3f5;
            --gray_2: #e9ecef;
            --gray_3: #dee2e6;
            --gray_4: #ced4da;
            --gray_5: #adb5bd;
            --gray_6: #868e96;
            --gray_7: #495057;
            --gray_8: #343a40;
            --gray_9: #212529;
            --pressed_btn: #0056b3;
            --isep: #991a23;
            --isep_chat: #cd3535;
    
            /* FONT SIZES */
            --font_size_1: 0.225rem;    /* 3.6px */
            --font_size_2: 0.45rem;     /* 7.2px */
            --font_size_3: 0.675rem;    /* 10.8px */
            --font_size_4: 0.9rem;      /* 14.4px */
            --font_size_5: 1.125rem;    /* 18px */
            --font_size_6: 1.35rem;     /* 21.6px */
            --font_size_7: 1.575rem;    /* 25.2px */
            --font_size_8: 1.8rem;      /* 28.8px */
            --font_size_9: 2.025rem;    /* 32.4px */
            --font_size_10: 2.7rem;     /* 43.2px */
            --font_size_11: 3.375rem;   /* 54px */
            --font_size_12: 4.05rem;    /* 64.8px */    
    
            /* FONT WEIGHTS */
            --font_weight_title: 600;
            --font_weight_subtitle: 600;
            --font_weight_description: 400;
            --font_weight_small_description: 300;
    
            /* LINE HEIGHTS */
            --line_height_title: 2.375rem;
            --line_height_subtitle: 1.5rem;
            --line_height_description: 1.25rem;
            --line_height_small_description: 1rem;
    
            --space_1: 0.225rem;    /* 3.6px */
            --space_2: 0.45rem;     /* 7.2px */
            --space_3: 0.675rem;    /* 10.8px */
            --space_4: 0.9rem;      /* 14.4px */
            --space_5: 1.125rem;    /* 18px */
            --space_6: 1.35rem;     /* 21.6px */
            --space_7: 1.575rem;    /* 25.2px */
            --space_8: 1.8rem;      /* 28.8px */
            --space_9: 2.025rem;    /* 32.4px */
            --space_10: 2.7rem;     /* 43.2px */
            --space_11: 3.375rem;   /* 54px */
            --space_12: 4.05rem;    /* 64.8px */
            --space_13: 5.4rem;     /* 64.8px */        
    
            /* MISC */
            --header-height: 100px;
            --input-height: 100px;
        }


        header {
            background-color: var(--isep_chat);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space_4) var(--space_6);
            width: 100%;
            top: 0;
            height: var(--header-height);

            img {
                width: 60px;
            }

            p {
                text-decoration: none;
                cursor: pointer;
                color: var(--white);
                margin: var(--space_2) 0;
                font-size: var(--font_size_5);
            }
        }

        main {
            height: calc(100vh - var(--header-height) - var(--input-height));
            overflow: scroll;
            padding: var(--space_2) var(--space_4);

            .message-sent {
                text-align: left;
            }

            .message-received {
                text-align: right;
            }
        }

        form {
            width: 100%;
            position: absolute;
            bottom: 0;
            padding: var(--space_2) var(--space_4);
            height: var(--input-height);
            background-color: var(--isep_chat);
            display: grid;
            column-gap: var(--space_5);
            grid-template-columns: 1fr 100px;

            textarea {
                height: 100%;
                border-radius: var(--space_2);
                padding: var(--space_2) var(--space_2);
                grid-column: 1 / 2;
                resize: none;
            }

            button {
                height: 100%;
                grid-column: 2 / 3;
                border-radius: var(--space_2);
            }
        }
    </style>
</head>
<body>
    <header>
        <img src="isep_chat_logo.png" alt="ISEPChat Logo">
        <p id='end-chat-btn' class="roboto-bold">Terminar conversa</p>
    </header>
    <main id="chat-window">
    </main>
    <form id="message-form">
        <textarea type="text" id="message-input" required placeholder="Escreva aqui a sua mensagem..."></textarea>
        <button type="submit">&#9658;</button>
    </form>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script type="module">
        import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

        // Firebase configuration:
        const firebaseConfig = {
            apiKey: "AIzaSyDIJX5VkIIkQXjAymM9_X721jZ5ce5Lw6c",
            authDomain: "isepchat.firebaseapp.com",
            databaseURL: "https://isepchat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "isepchat",
            storageBucket: "isepchat.appspot.com",
            messagingSenderId: "715861516084",
            appId: "1:715861516084:web:a4c8e3aa11385a4e8ecf61"
        };

        // Initialize Firebase:
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get("chatId");
        const chatRef = ref(database, `chats/${chatId}`);
        const userId = localStorage.getItem("userId");

        document.getElementById("end-chat-btn").addEventListener("click", () => {
            // Update chat object and remove user
            onValue(chatRef, (snapshot) => {
                const chat = snapshot.val();
                if (!chat) return;

                const updatedData = {};
                if (chat.user1 === userId) updatedData.user1 = null;
                if (chat.user2 === userId) updatedData.user2 = null;
                updatedData.hasAUserLeft = true;

                update(chatRef, updatedData).then(() => {
                    remove(ref(database, `users/${userId}`));

                    // Check if both users have left, then remove chat
                    onValue(chatRef, (updatedSnapshot) => {
                        const updatedChat = updatedSnapshot.val();
                        if (!updatedChat.user1 && !updatedChat.user2) {
                            remove(chatRef);
                        }
                    }, { onlyOnce: true });

                    window.location.href = "home.html";
                });
            }, { onlyOnce: true });
        });

        onValue(chatRef, (snapshot) => {
            const chat = snapshot.val();
            const chatWindow = document.getElementById("chat-window");
            chatWindow.innerHTML = "";

            if (chat.messages) {
            Object.entries(chat.messages).forEach(([key, message]) => {
                const messageElement = document.createElement("p");
                const senderElement = document.createElement("b");
                senderElement.textContent = `${message.userId === userId ? "Você" : "Colega"}: `;
                const messageText = document.createTextNode(message.text);
                messageElement.appendChild(senderElement);
                messageElement.appendChild(messageText);
                messageElement.style.textAlign = message.userId === userId ? "left" : "right";
                chatWindow.appendChild(messageElement);
            });
}

            if (!chat.user1 || !chat.user2) {
                const statusMessage = document.createElement("p");
                statusMessage.textContent = chat.hasAUserLeft ? "O teu colega saiu da conversa!" : "A espera de um colega...";
                statusMessage.style.textAlign = "center";
                statusMessage.style.color = "red";
                statusMessage.style.fontWeight = "bold"
                chatWindow.appendChild(statusMessage);
            }

            chatWindow.scrollTop = chatWindow.scrollHeight;
        });

        document.getElementById("message-form").addEventListener("submit", (event) => {
            event.preventDefault();
            const messageInput = document.getElementById("message-input");
            const messageText = messageInput.value.trim();

            if (messageText) {
                push(ref(database, `chats/${chatId}/messages`), {
                    userId,
                    text: messageText,
                }).then(() => {
                    messageInput.value = "";
                });
            }
        });
    </script>
</body>
</html>
